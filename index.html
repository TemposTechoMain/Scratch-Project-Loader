<!DOCTYPE html>
<html>
  <head>

  </head>
  <body>
    <p id="progress">Loading scaffolding...</p>
    <div id="container" style="max-height: 100%; aspect-ratio: 4 / 3;"></div>

    <script src="https://cdn.jsdelivr.net/npm/@turbowarp/scaffolding@0.2.0/dist/scaffolding-min.js"></script>

    <script>
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);

      const id = urlParams.get('id');
      console.log(id);
      // See https://docs.turbowarp.org/unshared-projects#developers
      const getProjectMetadata = async (projectId) => {
        const response = await fetch(`https://trampoline.turbowarp.org/api/projects/${projectId}`);
        if (response.status === 404) {
          throw new Error('The project is unshared or does not exist');
        }
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status} fetching project metadata`);
        }
        const json = await response.json();
        return json;
      };
      const getProjectData = async (projectId) => {
        const metadata = await getProjectMetadata(projectId);
        const token = metadata.project_token;
        const response = await fetch(`https://projects.scratch.mit.edu/${projectId}?token=${token}`);
        if (!response.ok) {
          throw new Error(`HTTP error ${response.status} fetching project data`);
        }
        const data = await response.arrayBuffer();
        return data;
      };

      const scaffolding = new Scaffolding.Scaffolding();
      scaffolding.editableLists = true;
      scaffolding.setup();
      scaffolding.appendTo(document.querySelector('#container'));
      document.querySelector('#progress').textContent = `noo`;
      const vm = scaffolding.vm;
      const storage = scaffolding.storage;

      // TurboWarp-only extension
      vm.on('ASSET_PROGRESS', (finished, total) => {
        document.querySelector('#progress').textContent = `Loading assets: ${finished} / ${total}`;
      });

      storage.addWebStore(
        [storage.AssetType.ImageVector, storage.AssetType.ImageBitmap, storage.AssetType.Sound],
        (asset) => `https://assets.scratch.mit.edu/internalapi/asset/${asset.assetId}.${asset.dataFormat}/get/`
      );

      (async () => {
        document.querySelector('#progress').textContent = 'Loading project data...';
        const project = await getProjectData(id);
        await scaffolding.loadProject(project);
        document.querySelector('#progress').textContent = '';
        scaffolding.greenFlag();
      })();
    </script>
  </body>
</html>
